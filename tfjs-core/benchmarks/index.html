<html>

<body>
  <script src="./tf-core.js"></script>
  <script src="./tf-converter.js"></script>
  <script>
    'use strict';

    tf.registerOp('BroadcastTo', node => {
      const x = node.inputs[0];
      const shape = node.inputs[1];
      return x.expandDims(0);
    });

    tf.registerOp('MatrixBandPart', node => {
      const x = node.inputs[0];
      const numLower = node.inputs[1].arraySync();
      const numUpper = node.inputs[2].arraySync();
      return tf.linalg.bandPart(x, numLower, numUpper);
    });

    const state = {
      numRuns: 1,
      benchmark: 'music_decode_target',
      run: (v) => {
        runBenchmark();
      },
    };

    let model;

    async function warmUpAndRecordTime() {
      let res = model.executeAsync({
          'decode_length': tf.scalar(50, 'int32'),
          'targets': tf.tensor2d([185, 290, 46, 49, 219, 292], [1, 6], 'int32')
        });
      if (res instanceof Promise) {
        res = await res;
      }

      if (res instanceof tf.Tensor) {
        res = await res.data();
      }

      console.log(res);
    }

    async function loadAndRecordTime() {
      const url =
          'https://storage.googleapis.com/learnjs-data/tfjs_graph_music_decode_target/model.json';
      model = await tf.loadGraphModel(url);
    }

    async function runBenchmark() {
      await loadAndRecordTime();
      await warmUpAndRecordTime();
    }

    async function onPageLoad() {
      await tf.ready();
      runBenchmark();
    }

    onPageLoad();
  </script>
</body>

</html>
